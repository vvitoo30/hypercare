<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Patient Detail - Hypercare Admin</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />

    <!-- Google Font: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap"
      rel="stylesheet"
    />

    <!-- Custom CSS -->
    <style>
      /* --- BASE STYLES --- */
      body, html {
        font-family: "Poppins", sans-serif;
        height: 100%;
        margin: 0;
        display: flex;
        flex-direction: column;
      }

      /* --- COLORS --- */
      .bg-dark-custom {
        background-color: #1c1c3a;
      }
      .bg-light-custom {
        background-color: #f4f6ff;
      }

      /* --- LAYOUT SECTIONS --- */
      .top-section {
        background-color: #1c1c3a;
        padding-bottom: 2rem;
      }
      
      .bottom-section {
        background-color: #f4f6ff;
        flex-grow: 1;
        padding: 2rem 1rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
      }

      /* --- BACK ARROW --- */
      .back-arrow {
        color: #ffffff;
        font-size: 2rem;
        text-decoration: none;
      }
      .back-arrow:hover {
        color: #cccccc;
      }

      /* --- PATIENT INFO CARD --- */
      .patient-info-card {
        background-color: #f4f6ff;
        border-radius: 1.5rem;
        padding: 1.5rem;
        color: #000000;
      }

      .info-label {
        font-weight: bold;
        font-size: 1.1rem;
        margin-bottom: 0.25rem;
      }
      
      .info-content {
        font-size: 0.95rem;
        margin-bottom: 1rem;
        color: #333;
      }
      
      /* Skeleton loading effect */
      .skeleton {
          background-color: #e0e0e0;
          color: transparent;
          border-radius: 4px;
          animation: pulse 1.5s infinite;
      }
      @keyframes pulse {
          0% { opacity: 0.6; }
          50% { opacity: 1; }
          100% { opacity: 0.6; }
      }

      .custom-hr {
        border-top: 2px solid #6a60e9;
        opacity: 1;
        margin: 0.5rem 0 1rem 0;
      }

      /* --- SHOW RECORDS BUTTON --- */
      .btn-show-records {
        background-color: #6a60e9;
        color: #ffffff;
        font-weight: bold;
        border-radius: 2rem;
        padding: 0.75rem 1.5rem;
        border: none;
        font-size: 1rem;
        margin-top: 2rem;
        display: inline-block;
        box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        text-decoration: none;
        cursor: pointer;
      }
      .btn-show-records:hover {
        background-color: #584fc9;
        color: #ffffff;
      }

      /* --- ACTION BUTTONS (BOTTOM) --- */
      .btn-action-dark {
        background-color: #1c1c3a;
        color: #ffffff;
        font-weight: bold;
        border-radius: 1rem;
        padding: 1rem;
        border: none;
        font-size: 1rem;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        cursor: pointer;
      }
      .btn-action-dark:hover {
        background-color: #2a2a55;
        color: #ffffff;
      }

      .buttons-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        width: 100%;
        max-width: 500px;
        margin-bottom: 1rem;
      }

      /* --- MODAL STYLES --- */
      .modal-backdrop-blur {
        backdrop-filter: blur(10px);
        background-color: rgba(0, 0, 0, 0.5);
        opacity: 1; 
      }
      
      .modal-content-dark {
        background-color: #1c1c3a;
        color: white;
        border-radius: 1rem;
        border: none;
        position: relative;
        overflow: hidden;
      }

      /* Checkup Rows inside Modal */
      .checkup-row {
        background-color: #ffffff;
        border-radius: 50rem;
        padding: 0.5rem 0.5rem 0.5rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .checkup-date {
        margin: 0;
        color: #000000;
        font-weight: bold;
        font-size: 1rem;
      }

      .btn-details {
        background-color: #4a43d1;
        color: #ffffff;
        font-weight: bold;
        border: none;
        border-radius: 50rem;
        padding: 0.5rem 1.5rem;
        font-size: 0.9rem;
      }
      .btn-details:hover {
        background-color: #3a32a0;
        color: #ffffff;
      }

      .link-show-more {
        color: #ffffff;
        text-decoration: none;
        font-weight: bold;
        font-size: 0.9rem;
        display: block;
        text-align: center;
        margin-top: 1rem;
      }
      .link-show-more:hover {
        color: #cccccc;
      }

      /* Detail Form Styles */
      .form-label-light {
        font-weight: bold;
        margin-bottom: 0.5rem;
        font-size: 1rem;
      }
      .form-control-pill-white {
        background-color: #ffffff;
        border-radius: 2rem;
        border: none;
        padding: 0.75rem 1.5rem;
        color: #1c1c3a;
        font-weight: bold;
      }
      .form-control-pill-white:focus {
        box-shadow: 0 0 0 0.25rem rgba(106, 96, 233, 0.5);
        outline: none;
      }

      /* --- Medication Schedule Modal Styles --- */
      .time-input-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .time-box {
        width: 3.5rem;
        height: 3.5rem;
        background-color: #ffffff;
        color: #4a43d1;
        border-radius: 0.75rem;
        border: none;
        font-size: 2rem;
        font-weight: bold;
        text-align: center;
        line-height: 1;
        padding: 0;
      }
      .time-colon {
        font-size: 2rem;
        font-weight: bold;
        color: #ffffff;
        margin: 0 0.25rem;
      }
      .btn-add-medication {
        background-color: #ffffff;
        color: #4a43d1;
        font-weight: bold;
        border-radius: 1rem;
        padding: 0.5rem 1rem;
        border: none;
        font-size: 0.9rem;
        float: right;
        margin-top: 0.5rem;
        margin-bottom: 1rem;
      }
      .btn-add-medication:hover {
        background-color: #f0f0f0;
      }
      .medication-group {
        border-bottom: 1px solid rgba(255,255,255,0.1);
        padding-bottom: 1.5rem;
        margin-bottom: 1.5rem;
      }
      .medication-group:last-child {
        border-bottom: none;
        margin-bottom: 0;
      }
      .btn-save-schedule {
        background-color: #4a43d1;
        color: white;
        font-weight: bold;
        font-size: 1.2rem;
        border-radius: 2rem;
        width: 100%;
        padding: 0.75rem;
        border: none;
        margin-top: 1rem;
      }
      .btn-save-schedule:hover {
        background-color: #3a32a0;
      }

      /* --- BP Save Button Style --- */
      .btn-save-bp {
        background-color: #4a43d1;
        color: #ffffff;
        font-weight: bold;
        font-size: 1.5rem;
        border-radius: 2rem;
        width: 100%;
        padding: 0.75rem;
        border: none;
        margin-top: 2rem;
      }
      .btn-save-bp:hover {
        background-color: #3a32a0;
      }

      /* --- Pharmacy Notes Styles --- */
      .pharmacy-note-textarea {
        background-color: #ffffff;
        border-radius: 1rem;
        padding: 1rem;
        color: #1c1c3a;
        font-weight: bold;
        border: none;
        width: 100%;
        min-height: 150px;
        margin-bottom: 1rem;
        font-size: 1rem;
      }
      .pharmacy-note-textarea::placeholder {
        color: #1c1c3a;
      }
      .btn-add-notes {
        background-color: #ffffff;
        color: #4a43d1;
        font-weight: bold;
        border-radius: 1rem;
        padding: 0.75rem;
        border: none;
        width: 48%;
        font-size: 1.1rem;
      }
      .btn-save-notes {
        background-color: #4a43d1;
        color: #ffffff;
        font-weight: bold;
        border-radius: 1rem;
        padding: 0.75rem;
        border: none;
        width: 48%;
        font-size: 1.1rem;
      }
      
      /* --- Medical Check Up Records Button Style --- */
      .btn-save-checkup {
        background-color: #4a43d1;
        color: white;
        font-weight: bold;
        font-size: 1.3rem;
        border-radius: 1rem;
        width: 50%;
        padding: 0.75rem;
        border: none;
        margin-top: 2rem;
      }
      .btn-save-checkup:hover {
          background-color: #3a32a0;
      }

      /* --- Save Animation Overlay --- */
      .save-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(28, 28, 58, 0.95);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1050;
        border-radius: 1rem;
      }
      .save-icon {
        font-size: 4rem;
        color: #ffffff;
        margin-bottom: 1rem;
      }
      .save-text {
        color: #ffffff;
        font-weight: bold;
        font-size: 1.5rem;
      }
    </style>
  </head>
  <body>

    <!-- === TOP SECTION (Dark) === -->
    <div class="top-section container-fluid">
      <div class="container pt-4">
        <!-- Back Button -->
        <a href="doctor_dashboard.html" class="back-arrow mb-3 d-inline-block">
          <i class="bi bi-arrow-left"></i>
        </a>

        <!-- Title -->
        <h1 class="text-white fw-bold mb-4">Patient Detail</h1>

        <!-- Patient Info Card -->
        <div class="patient-info-card shadow-sm">
          <!-- Added IDs for Dynamic Data -->
          <div class="fw-bold fs-5" id="pName">Loading Name...</div>
          <hr class="custom-hr">
          
          <div class="fw-bold mb-3" id="pLocDob"><span class="skeleton">Loading Location...</span></div>
          <hr class="custom-hr">

          <div class="info-label">Medical Report</div>
          <div class="info-content" id="pReport">
            <span class="skeleton">Loading report data...</span>
          </div>
          <hr class="custom-hr">

          <div class="info-label">History of Drugs Allergies</div>
          <div class="info-content" id="pAllergies">
             <span class="skeleton">Loading allergies...</span>
          </div>
          <hr class="custom-hr">

          <div class="info-label">Medication</div>
          <div class="info-content mb-0" id="pMeds">
             <span class="skeleton">Loading medication...</span>
          </div>
        </div>

        <!-- Button triggers the checkup modal -->
        <div class="text-center"> 
            <button 
              class="btn-show-records" 
              data-bs-toggle="modal" 
              data-bs-target="#medicalCheckupModal"
              onclick="loadCheckupHistory()"
            >
                Show Medical Check Up Records
            </button>
        </div>
      </div>
    </div>

    <!-- === BOTTOM SECTION (Light) === -->
    <div class="bottom-section">
      <div class="container d-flex flex-column align-items-center w-100">
        
        <!-- Buttons Grid (2x2) -->
        <div class="buttons-grid">
          <button 
            class="btn-action-dark"
            data-bs-toggle="modal"
            data-bs-target="#medicationScheduleModal"
          >
            Medication<br>Schedule
          </button>
          
          <button 
            class="btn-action-dark"
            data-bs-toggle="modal" 
            data-bs-target="#bloodPressureModal"
          >
            Blood Pressure<br>Records
          </button>

          <button 
            class="btn-action-dark"
            data-bs-toggle="modal"
            data-bs-target="#pharmacyNotesModal"
          >
            Pharmacy<br>Notes
          </button>
          
          <button 
            class="btn-action-dark"
            data-bs-toggle="modal"
            data-bs-target="#medicalCheckupRecordsModal"
          >
             Medical Check<br>up Records
          </button>
        </div>

      </div>
    </div>

    <!-- === MODAL 1: Medical Check Up History & Details === -->
    <div class="modal fade" id="medicalCheckupModal" tabindex="-1" aria-hidden="true" data-bs-backdrop-class="modal-backdrop-blur">
      <div class="modal-dialog modal-dialog-centered modal-lg"> 
        <div class="modal-content modal-content-dark p-3">
          <div class="modal-body">
            
            <!-- VIEW 1: History List -->
            <div id="checkupHistoryView">
              <h2 class="fw-bold mb-2">Medical Check Up History</h2>
              <p class="text-white-50 mb-4">Review your patient’s medical check up history</p>
              
              <div id="checkupHistoryList">
                  <!-- Dynamic Rows will be injected here -->
                  <div class="text-center text-white-50 py-3">Loading history...</div>
              </div>

              <div class="text-center mt-4">
                <button type="button" class="btn btn-outline-light rounded-pill px-4" data-bs-dismiss="modal">Close</button>
              </div>
            </div>

            <!-- VIEW 2: Detail Form (Read Only) -->
            <div id="checkupDetailView" class="d-none">
               <div class="mb-3">
                 <button class="btn text-white p-0" onclick="hideCheckupDetail()">
                   <i class="bi bi-arrow-left fs-2"></i>
                 </button>
               </div>

              <h2 class="fw-bold mb-2">Check Up Detail</h2>
              <form>
                <div class="mb-3">
                  <label class="form-label-light">Date</label>
                  <input type="text" class="form-control form-control-pill-white" id="detailDate" readonly>
                </div>
                <div class="mb-3">
                  <label class="form-label-light">Blood Pressure (Sys/Dia)</label>
                  <input type="text" class="form-control form-control-pill-white" id="detailBP" readonly>
                </div>
                <div class="mb-3">
                  <label class="form-label-light">Medication Prescribed</label>
                  <input type="text" class="form-control form-control-pill-white" id="detailMeds" readonly>
                </div>
                <div class="mb-3">
                  <label class="form-label-light">Notes</label>
                  <textarea class="form-control form-control-pill-white" id="detailNotes" rows="3" readonly></textarea>
                </div>
              </form>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- === MODAL 2: Medication Schedule === -->
    <div class="modal fade" id="medicationScheduleModal" tabindex="-1" aria-hidden="true" data-bs-backdrop-class="modal-backdrop-blur">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-content-dark p-3">
          <div id="medicationSaveOverlay" class="save-overlay d-none">
            <i class="bi bi-check-circle-fill save-icon"></i>
            <div class="save-text">Saved!</div>
          </div>

          <div class="modal-header border-0 pb-0">
             <button type="button" class="btn text-white p-0" data-bs-dismiss="modal">
               <i class="bi bi-arrow-left fs-2"></i>
             </button>
          </div>
          <div class="modal-body pt-2">
            <h2 class="fw-bold mb-2">Medication Schedule</h2>
            <p class="text-white-50 mb-4">Add Medication Schedule to your patient</p>

            <div id="medicationContainer">
              <!-- First Group -->
              <div class="medication-group">
                <div class="mb-3">
                  <label class="form-label-light fs-4">Time</label>
                  <div class="time-input-group">
                    <input type="text" class="time-box h1" maxlength="1" placeholder="0">
                    <input type="text" class="time-box h2" maxlength="1" placeholder="0">
                    <span class="time-colon">:</span>
                    <input type="text" class="time-box m1" maxlength="1" placeholder="0">
                    <input type="text" class="time-box m2" maxlength="1" placeholder="0">
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label-light fs-4">Medication</label>
                  <textarea class="form-control form-control-pill-white med-name" rows="2" placeholder="e.g. Paracetamol 500mg"></textarea>
                </div>
              </div>
            </div>

            <div class="clearfix">
               <button class="btn-add-medication" onclick="addMedicationGroup()">
                 Add Another<br>Medication
               </button>
            </div>

            <div class="mt-4">
              <button class="btn-save-schedule" onclick="saveMedicationSchedule()">
                Save Schedule
              </button>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- === MODAL 3: Blood Pressure Records === -->
    <div class="modal fade" id="bloodPressureModal" tabindex="-1" aria-hidden="true" data-bs-backdrop-class="modal-backdrop-blur">
      <div class="modal-dialog modal-dialog-centered modal-lg"> 
        <div class="modal-content modal-content-dark p-3">
          <div id="bpSaveOverlay" class="save-overlay d-none">
            <i class="bi bi-check-circle-fill save-icon"></i>
            <div class="save-text">Saved!</div>
          </div>

          <div class="modal-header border-0 pb-0">
             <button type="button" class="btn text-white p-0" data-bs-dismiss="modal">
               <i class="bi bi-arrow-left fs-2"></i>
             </button>
          </div>
          <div class="modal-body pt-2">
            
            <div id="bpDetailView">
              <h2 class="fw-bold mb-2">Blood Pressure Records</h2>
              <p class="text-white-50 mb-4">Add your patient’s blood pressure for monitoring</p>

              <form>
                <div class="mb-4">
                  <label class="form-label-light">Systolic (mmHg)</label>
                  <input type="number" id="bpSystolic" class="form-control form-control-pill-white" placeholder="120">
                </div>

                <div class="mb-4">
                  <label class="form-label-light">Diastolic (mmHg)</label>
                  <input type="number" id="bpDiastolic" class="form-control form-control-pill-white" placeholder="80">
                </div>

                <div class="mt-5">
                  <button type="button" class="btn-save-bp" onclick="saveBPRecord()">
                    Save BP Records
                  </button>
                </div>
              </form>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- === MODAL 4: Pharmacy Notes === -->
    <div class="modal fade" id="pharmacyNotesModal" tabindex="-1" aria-hidden="true" data-bs-backdrop-class="modal-backdrop-blur">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-content-dark p-3">
          <div id="pharmacySaveOverlay" class="save-overlay d-none">
            <i class="bi bi-check-circle-fill save-icon"></i>
            <div class="save-text">Saved!</div>
          </div>

          <div class="modal-header border-0 pb-0">
             <button type="button" class="btn text-white p-0" data-bs-dismiss="modal">
               <i class="bi bi-arrow-left fs-2"></i>
             </button>
          </div>
          <div class="modal-body pt-2">
            <h2 class="fw-bold mb-2">Pharmacy Notes</h2>
            <p class="text-white-50 mb-4">Add notes to your patient</p>

            <div id="pharmacyNotesContainer">
              <textarea 
                id="pharmacyNoteInput"
                class="pharmacy-note-textarea" 
                rows="6" 
                placeholder="Enter pharmacy notes here..."
              ></textarea>
            </div>

            <div class="d-flex justify-content-between mt-3">
              <!-- Simplified: Just one main save button for the text area -->
              <button class="btn-save-notes w-100" onclick="savePharmacyNote()">
                Save Notes
              </button>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- === MODAL 5: Add Medical Check Up Record === -->
    <div class="modal fade" id="medicalCheckupRecordsModal" tabindex="-1" aria-hidden="true" data-bs-backdrop-class="modal-backdrop-blur">
      <div class="modal-dialog modal-dialog-centered modal-lg"> 
        <div class="modal-content modal-content-dark p-3">
          <div id="checkupSaveOverlay" class="save-overlay d-none">
            <i class="bi bi-check-circle-fill save-icon"></i>
            <div class="save-text">Saved!</div>
          </div>

          <div class="modal-header border-0 pb-0">
             <button type="button" class="btn text-white p-0" data-bs-dismiss="modal">
               <i class="bi bi-arrow-left fs-2"></i>
             </button>
          </div>
          <div class="modal-body pt-2">
            <h2 class="fw-bold mb-2">Add Medical Record</h2>
            <p class="text-white-50 mb-4">Add a new check-up entry</p>

            <form onsubmit="return false;">
                <!-- Date is auto-generated by server timestamp -->
                <div class="row">
                    <div class="col-6 mb-3">
                        <label class="form-label-light">Systolic</label>
                        <input type="number" id="chkSys" class="form-control form-control-pill-white">
                    </div>
                    <div class="col-6 mb-3">
                        <label class="form-label-light">Diastolic</label>
                        <input type="number" id="chkDia" class="form-control form-control-pill-white">
                    </div>
                </div>
                <div class="mb-3">
                  <label class="form-label-light">Medication Prescribed</label>
                  <input type="text" id="chkMeds" class="form-control form-control-pill-white">
                </div>
                <div class="mb-3">
                  <label class="form-label-light">Notes / Allergies</label>
                  <input type="text" id="chkNotes" class="form-control form-control-pill-white">
                </div>

                <div class="text-center">
                  <button type="button" class="btn-save-checkup" onclick="saveNewCheckup()">
                    Save Records
                  </button>
                </div>
            </form>

          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <!-- Config (Must exist in same folder) -->
    <script src="firebase-config.js"></script>

    <!-- Custom JS -->
    <script>
      // --- 1. Initialize Firebase ---
      const db = firebase.firestore();
      const auth = firebase.auth();
      
      // Get Patient ID from URL
      const urlParams = new URLSearchParams(window.location.search);
      const patientId = urlParams.get('id');

      // --- 2. Load Patient Data on Start ---
      auth.onAuthStateChanged((user) => {
        if (user && patientId) {
            loadPatientProfile(patientId);
        } else if (!patientId) {
            alert("No patient selected.");
            window.location.href = "doctor_dashboard.html";
        }
      });

      function loadPatientProfile(id) {
        db.collection("users").doc(id).onSnapshot((doc) => {
            if (doc.exists) {
                const data = doc.data();
                
                // Populate HTML elements with IDs
                document.getElementById('pName').innerText = `${data.username || 'Unknown'} (${data.age || 'N/A'})`;
                document.getElementById('pLocDob').innerText = data.location_dob || 'No Location Info';
                document.getElementById('pReport').innerText = data.medical_report || 'No Report';
                document.getElementById('pAllergies').innerText = data.allergies || 'None';
                document.getElementById('pMeds').innerText = data.medication || 'None';
            } else {
                alert("Patient not found!");
            }
        });
      }

      // --- 3. Save Helpers ---
      function showOverlayAndClose(modalId, overlayId) {
        const overlay = document.getElementById(overlayId);
        const modalEl = document.getElementById(modalId);
        const modal = bootstrap.Modal.getInstance(modalEl);

        overlay.classList.remove('d-none');
        setTimeout(() => {
          overlay.classList.add('d-none');
          modal.hide();
          // Clear inputs
          const inputs = modalEl.querySelectorAll('input, textarea');
          inputs.forEach(input => input.value = '');
        }, 1500);
      }

      // --- 4. Logic: Save Blood Pressure ---
      async function saveBPRecord() {
        const sys = document.getElementById('bpSystolic').value;
        const dia = document.getElementById('bpDiastolic').value;

        if(!sys || !dia) return alert("Please fill in both fields");

        try {
            await db.collection("users").doc(patientId).collection("blood_pressure").add({
                systolic: sys,
                diastolic: dia,
                recordedAt: firebase.firestore.FieldValue.serverTimestamp(),
                recordedBy: auth.currentUser.email
            });
            showOverlayAndClose('bloodPressureModal', 'bpSaveOverlay');
        } catch (e) {
            console.error(e);
            alert("Error saving: " + e.message);
        }
      }

      // --- 5. Logic: Save Pharmacy Notes ---
      async function savePharmacyNote() {
        const note = document.getElementById('pharmacyNoteInput').value;
        if(!note) return alert("Please write a note");

        try {
            await db.collection("users").doc(patientId).collection("pharmacy_notes").add({
                note: note,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            showOverlayAndClose('pharmacyNotesModal', 'pharmacySaveOverlay');
        } catch (e) {
            alert("Error: " + e.message);
        }
      }

      // --- 6. Logic: Save Medication Schedule ---
      async function saveMedicationSchedule() {
        // Gather all medication groups
        const groups = document.querySelectorAll('.medication-group');
        let schedules = [];
        
        groups.forEach(group => {
            const h1 = group.querySelector('.h1').value || '0';
            const h2 = group.querySelector('.h2').value || '0';
            const m1 = group.querySelector('.m1').value || '0';
            const m2 = group.querySelector('.m2').value || '0';
            const medName = group.querySelector('.med-name').value;
            
            if(medName) {
                schedules.push({
                    time: `${h1}${h2}:${m1}${m2}`,
                    medication: medName
                });
            }
        });

        if(schedules.length === 0) return alert("Please add at least one medication.");

        try {
            // We add a batch or single document depending on preference. 
            // Here we add one document containing the array of schedules for this update.
            await db.collection("users").doc(patientId).collection("medication_schedules").add({
                items: schedules,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            showOverlayAndClose('medicationScheduleModal', 'medicationSaveOverlay');
            // Clear extra groups
            document.getElementById('medicationContainer').innerHTML = ''; 
            addMedicationGroup(); // Add one empty back
        } catch (e) {
            alert("Error: " + e.message);
        }
      }

      function addMedicationGroup() {
        const container = document.getElementById('medicationContainer');
        const html = `
          <div class="medication-group">
            <div class="mb-3">
              <label class="form-label-light fs-4">Time</label>
              <div class="time-input-group">
                <input type="text" class="time-box h1" maxlength="1" placeholder="0">
                <input type="text" class="time-box h2" maxlength="1" placeholder="0">
                <span class="time-colon">:</span>
                <input type="text" class="time-box m1" maxlength="1" placeholder="0">
                <input type="text" class="time-box m2" maxlength="1" placeholder="0">
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label-light fs-4">Medication</label>
              <textarea class="form-control form-control-pill-white med-name" rows="2"></textarea>
            </div>
          </div>`;
        container.insertAdjacentHTML('beforeend', html);
      }

      // --- 7. Logic: Save New Checkup ---
      async function saveNewCheckup() {
        const sys = document.getElementById('chkSys').value;
        const dia = document.getElementById('chkDia').value;
        const meds = document.getElementById('chkMeds').value;
        const notes = document.getElementById('chkNotes').value;

        try {
            await db.collection("users").doc(patientId).collection("checkup_records").add({
                bp: `${sys}/${dia}`,
                medication: meds,
                notes: notes,
                date: firebase.firestore.FieldValue.serverTimestamp()
            });
            showOverlayAndClose('medicalCheckupRecordsModal', 'checkupSaveOverlay');
            // Refresh the history list if it's open or next time it opens
        } catch(e) {
            alert("Error: " + e.message);
        }
      }

      // --- 8. Logic: Load Checkup History ---
      function loadCheckupHistory() {
        const list = document.getElementById('checkupHistoryList');
        list.innerHTML = '<div class="text-center text-white-50">Loading...</div>';

        db.collection("users").doc(patientId).collection("checkup_records")
          .orderBy('date', 'desc')
          .get()
          .then(snapshot => {
             if(snapshot.empty) {
                 list.innerHTML = '<div class="text-center text-white-50">No records found.</div>';
                 return;
             }
             
             let html = '';
             snapshot.forEach(doc => {
                 const d = doc.data();
                 const dateObj = d.date ? d.date.toDate() : new Date();
                 const dateStr = dateObj.toLocaleDateString("en-GB", { weekday: 'long', year: 'numeric', month: 'numeric', day: 'numeric' });
                 
                 // Store data in data-attributes to show details easily
                 html += `
                  <div class="checkup-row">
                    <p class="checkup-date">${dateStr}</p>
                    <button class="btn btn-details" 
                        onclick="showCheckupDetail('${dateStr}', '${d.bp}', '${d.medication}', '${d.notes}')">
                        See Details
                    </button>
                  </div>
                 `;
             });
             list.innerHTML = html;
          });
      }

      function showCheckupDetail(date, bp, meds, notes) {
        document.getElementById('checkupHistoryView').classList.add('d-none');
        document.getElementById('checkupDetailView').classList.remove('d-none');
        
        document.getElementById('detailDate').value = date;
        document.getElementById('detailBP').value = bp;
        document.getElementById('detailMeds').value = meds;
        document.getElementById('detailNotes').value = notes;
      }

      function hideCheckupDetail() {
        document.getElementById('checkupDetailView').classList.add('d-none');
        document.getElementById('checkupHistoryView').classList.remove('d-none');
      }
    </script>
  </body>
</html>
