<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Doctor Dashboard - Hypercare</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <!-- Google Font: Poppins -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Custom CSS -->
    <style>
      /* --- BASE STYLES --- */
      body {
        font-family: "Poppins", sans-serif;
        background-color: #1c1c3a; /* Deep Dark Blue */
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        color: white;
      }

      .bg-dark-custom {
        background-color: #15152e;
      }

      /* --- ACTION BAR --- */
      .action-bar {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
      }
      
      .search-container {
        position: relative;
        flex-grow: 1;
      }
      .search-input {
        border-radius: 1rem;
        padding: 0.75rem 1.5rem;
        padding-right: 3.5rem;
        font-weight: 500;
        font-size: 1rem;
        color: #4a43d1;
        border: none;
        background-color: white;
        width: 100%;
        height: 3.5rem; 
      }
      .search-input:focus {
          box-shadow: 0 0 0 0.25rem rgba(106, 96, 233, 0.5);
          outline: none;
      }
      .search-icon-large {
        position: absolute;
        right: 1.2rem;
        top: 50%;
        transform: translateY(-50%);
        color: #4a43d1;
        font-size: 1.2rem;
      }

      .btn-register-header {
        background-color: #4a43d1;
        color: #ffffff;
        font-weight: 600;
        border-radius: 1rem;
        padding: 0 1.5rem;
        border: none;
        white-space: nowrap;
        height: 3.5rem; 
        display: flex;
        align-items: center;
        transition: all 0.2s ease;
      }
      .btn-register-header:hover {
        background-color: #3b35a8;
        transform: translateY(-2px);
      }

      /* --- PATIENT CARD --- */
      .patient-card {
        background-color: #ffffff;
        border-radius: 1.5rem;
        padding: 1.2rem 1.5rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        color: #333;
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid rgba(255,255,255,0.1);
        cursor: pointer; 
        text-decoration: none; 
      }
      .patient-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        background-color: #fdfdfd;
      }
      
      .patient-avatar {
        width: 60px;
        height: 60px;
        background-color: #e0e0ff; 
        color: #4a43d1;
        border-radius: 1rem;
        flex-shrink: 0;
        margin-right: 1.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: bold;
      }

      .patient-info {
        flex-grow: 1;
      }

      .patient-name {
        color: #1c1c3a;
        font-weight: 700;
        font-size: 1.1rem;
      }

      .patient-meta {
        font-size: 0.85rem;
        color: #666;
        margin-top: 0.1rem;
      }
      
      .patient-condition {
        display: inline-block;
        background-color: #fff0f0;
        color: #d63384;
        font-size: 0.75rem;
        padding: 0.2rem 0.6rem;
        border-radius: 2rem;
        font-weight: 600;
        margin-top: 0.3rem;
      }

      /* --- MODAL COMMON STYLES --- */
      .modal-content-dark {
        background-color: #252547;
        color: white;
        border-radius: 1.5rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .modal-content-light {
        background-color: #f4f6ff;
        color: #1c1c3a;
        border-radius: 1.5rem;
        border: none;
      }
      .modal-backdrop-blur {
        backdrop-filter: blur(5px);
        background-color: rgba(0, 0, 0, 0.5);
      }

      /* Form Controls */
      .form-control-custom {
        background-color: #1c1c3a;
        border: 1px solid #3f3f6b;
        border-radius: 0.8rem;
        padding: 0.7rem;
        color: white;
      }
      .form-control-custom:focus {
        background-color: #15152e;
        border-color: #4a43d1;
        color: white;
        box-shadow: none;
      }
      .form-control-pill-white {
        background-color: #ffffff;
        border-radius: 2rem;
        border: none;
        padding: 0.75rem 1.5rem;
        color: #1c1c3a;
        font-weight: bold;
      }
      .form-label-light {
        font-weight: bold;
        margin-bottom: 0.5rem;
        color: #ccc;
        font-size: 0.9rem;
      }
      
      /* Register Button */
      .btn-register-submit {
        background-color: #4a43d1;
        color: white;
        font-weight: bold;
        border-radius: 1rem;
        width: 100%;
        padding: 0.8rem;
        border: none;
        margin-top: 1rem;
      }
      .btn-register-submit:hover {
        background-color: #3b35a8;
      }

      /* --- PATIENT DETAIL MODAL SPECIFIC --- */
      .patient-detail-card {
        background-color: #f4f6ff;
        border-radius: 1.5rem;
        padding: 1.5rem;
        color: #000000;
        margin-bottom: 1.5rem;
      }
      .detail-label {
        font-weight: bold;
        font-size: 1rem;
        color: #4a43d1;
        margin-bottom: 0.2rem;
      }
      .detail-content {
        font-size: 0.95rem;
        color: #333;
        margin-bottom: 0.8rem;
      }
      .custom-hr {
        border-top: 1px solid #d1d1e0;
        margin: 0.5rem 0 1rem 0;
      }
      .buttons-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }
      .btn-action-grid {
        background-color: #1c1c3a;
        color: white;
        border-radius: 1rem;
        padding: 1rem;
        border: none;
        font-weight: bold;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      }
      .btn-action-grid:hover {
        background-color: #2a2a55;
        color: white;
      }
      .btn-show-records {
        background-color: #6a60e9;
        color: white;
        font-weight: bold;
        border-radius: 2rem;
        padding: 0.75rem 1.5rem;
        border: none;
        width: 100%;
      }

      /* Save Overlay */
      .save-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(28, 28, 58, 0.95);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1060;
        border-radius: 1.5rem;
      }
      
      /* Checkup Rows */
      .checkup-row {
        background-color: #ffffff;
        border-radius: 50rem;
        padding: 0.5rem 0.5rem 0.5rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        color: black;
      }
      .btn-details-small {
        background-color: #4a43d1;
        color: white;
        border-radius: 50rem;
        padding: 0.4rem 1.2rem;
        font-size: 0.85rem;
        border: none;
        font-weight: bold;
      }
      
      /* Medication Group Style */
      .medication-group {
        border-bottom: 1px solid rgba(255,255,255,0.1);
        padding-bottom: 1rem;
        margin-bottom: 1rem;
      }
      .medication-group:last-child {
        border-bottom: none;
      }
    </style>
    <script src="https://apis.google.com/js/api.js"></script>
  </head>
  <body>
    
    <!-- Header -->
    <header class="bg-dark-custom p-3 shadow-sm">
      <div class="container">
        <div class="d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center gap-2">
            <i class="bi bi-heart-pulse-fill text-white fs-4"></i>
            <span class="fs-4 fw-bold text-white">Hypercare</span>
          </div>
          
          <div class="dropdown">
            <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle" data-bs-toggle="dropdown">
              <div class="rounded-circle bg-secondary me-2 d-flex align-items-center justify-content-center" style="width: 35px; height: 35px; font-size:0.8rem;">Dr</div>
              <span class="fw-bold d-none d-sm-block" id="user-email">Doctor</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-dark shadow">
              <li><a class="dropdown-item" href="#" id="logout-button">Log Out</a></li>
            </ul>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="container mt-5">
      
      <div class="mb-4">
        <h1 class="fw-bold">Patient List</h1>
        <p class="text-white-50">Manage your registered patients and view their medical data.</p>
      </div>

      <!-- Action Bar -->
      <div class="action-bar">
        <div class="search-container">
          <input type="text" class="form-control search-input" placeholder="Search patient by name..." id="searchInput">
          <i class="bi bi-search search-icon-large"></i>
        </div>
        <button class="btn-register-header" data-bs-toggle="modal" data-bs-target="#registerPatientModal">
          <i class="bi bi-person-plus-fill me-2"></i>Register Patient
        </button>
        <a href="medication_management.html" class="btn-register-header">
          <i class="bi bi-capsule-pill me-2"></i>Manage Medications
        </a>
      </div>

      <!-- List Container -->
      <div id="patientListContainer">
        <div class="d-flex justify-content-center mt-5" id="loadingSpinner">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
        </div>
      </div>

    </main>

    <!-- ================= MODALS ================= -->

    <!-- 1. Register Modal -->
    <div class="modal fade" id="registerPatientModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-content-dark p-4">
          <div class="modal-header border-0 p-0 mb-3">
            <h3 class="modal-title fw-bold">Register New Patient</h3>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body p-0">
            <form id="registerForm">
              <div class="row">
                <div class="col-6 mb-3">
                    <label class="form-label-light">Full Name</label>
                    <input type="text" class="form-control form-control-custom" id="regName" required>
                </div>
                <div class="col-6 mb-3">
                    <label class="form-label-light">Age</label>
                    <input type="number" class="form-control form-control-custom" id="regAge" required>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label-light">Location / DOB</label>
                <input type="text" class="form-control form-control-custom" id="regLocation" required>
              </div>
              <div class="mb-3">
                <label class="form-label-light">Medical Report</label>
                <textarea class="form-control form-control-custom" id="regReport" rows="2" required></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label-light">Allergies</label>
                <input type="text" class="form-control form-control-custom" id="regAllergies" required>
              </div>
              <div class="mb-3">
                <label class="form-label-light">Current Medication</label>
                <input type="text" class="form-control form-control-custom" id="regMedication" required>
              </div>
              <button type="submit" class="btn-register-submit">Save Patient</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- 2. Logout Modal -->
    <div class="modal fade" id="logoutModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-content-dark p-4 text-center">
          <div class="modal-body p-0">
            <!-- Confirmation -->
            <div id="logoutConfirmContent">
              <div class="mb-4">
                <div class="mx-auto d-flex align-items-center justify-content-center rounded-circle" style="width: 80px; height: 80px; background-color: rgba(74, 67, 209, 0.1);">
                  <i class="bi bi-box-arrow-right" style="font-size: 2.5rem; color: #4a43d1;"></i>
                </div>
              </div>
              <h3 class="fw-bold mb-2">Log Out</h3>
              <p class="text-white-50 mb-4">Are you sure you want to log out?</p>
              <div class="row g-3">
                <div class="col-6">
                  <button type="button" class="btn btn-outline-light w-100 py-2 rounded-pill fw-bold" data-bs-dismiss="modal" style="border: 1px solid rgba(255,255,255,0.2);">Cancel</button>
                </div>
                <div class="col-6">
                  <button type="button" class="btn w-100 py-2 rounded-pill fw-bold" id="confirmLogoutBtn" style="background-color: #4a43d1; color: white;">Log Out</button>
                </div>
              </div>
            </div>
            <!-- Loading -->
            <div id="logoutLoadingContent" class="d-none py-3">
               <div class="spinner-border text-light mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
               <h4 class="fw-bold">Logging you out...</h4>
               <p class="text-white-50 m-0">Please be patient</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 3. MAIN PATIENT DETAIL MODAL (The Pop-up Card) -->
    <div class="modal fade" id="patientDetailModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content modal-content-dark">
          <!-- Header -->
          <div class="modal-header border-0 p-4 pb-0">
             <h3 class="modal-title fw-bold">Patient Detail</h3>
             <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <!-- Body -->
          <div class="modal-body p-4">
             <!-- Patient Info Card (Light) -->
             <div class="patient-detail-card">
                <div class="d-flex justify-content-between align-items-center">
                  <div class="fw-bold fs-5 text-dark" id="modalPName">Loading...</div>
                  <div>
                    <button class="btn btn-sm btn-primary" id="editPatientBtn" onclick="toggleEditMode(true)">Edit</button>
                    <button class="btn btn-sm btn-success d-none" id="savePatientBtn" onclick="savePatientDetails()">Save</button>
                    <button class="btn btn-sm btn-secondary d-none" id="cancelEditBtn" onclick="toggleEditMode(false)">Cancel</button>
                  </div>
                </div>
                <hr class="custom-hr">
                
                <div id="patient-details-view">
                  <div class="detail-label">Location / DOB</div>
                  <div class="detail-content" id="modalPLocDob">...</div>
                  
                  <div class="detail-label">Medical Report</div>
                  <div class="detail-content" id="modalPReport">...</div>
                  
                  <div class="detail-label">Allergies</div>
                  <div class="detail-content" id="modalPAllergies">...</div>
                  
                  <div class="detail-label">Medication</div>
                  <div class="detail-content mb-0" id="modalPMeds">...</div>
                </div>

                <div id="patient-details-edit" class="d-none">
                  <div class="mb-3">
                    <label class="form-label">Location / DOB</label>
                    <input type="text" class="form-control" id="editPLocDob">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Medical Report</label>
                    <textarea class="form-control" id="editPReport" rows="2"></textarea>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Allergies</label>
                    <input type="text" class="form-control" id="editPAllergies">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Medication</label>
                    <input type="text" class="form-control" id="editPMeds">
                  </div>
                </div>
             </div>

             <!-- History Button -->
             <button class="btn-show-records mb-4" onclick="openCheckupHistory()">
               Show Medical Check Up Records
             </button>

             <!-- Grid Buttons -->
             <div class="buttons-grid">
               <button class="btn-action-grid" data-bs-toggle="modal" data-bs-target="#medicationScheduleModal">
                 Add Medication<br>Schedule
               </button>
               <button class="btn-action-grid" onclick="openViewMedicationSchedules()">
                 View Medication<br>Schedules
               </button>
               <button class="btn-action-grid" data-bs-toggle="modal" data-bs-target="#bloodPressureModal">
                 Blood Pressure<br>Records
               </button>
               <button class="btn-action-grid" data-bs-toggle="modal" data-bs-target="#pharmacyNotesModal">
                 Pharmacy<br>Notes
               </button>
               <button class="btn-action-grid" data-bs-toggle="modal" data-bs-target="#medicalCheckupRecordsModal">
                 Add Medical<br>Record
               </button>
             </div>
             <div id="google-auth-buttons" class="mt-4">
                <button id="authorize_button" class="btn btn-primary">Authorize Google Calendar</button>
                <button id="signout_button" class="btn btn-danger">Sign Out</button>
             </div>
          </div>
        </div>
      </div>
    </div>

    <!-- VIEW MEDICATION SCHEDULES MODAL -->
    <div class="modal fade" id="viewMedicationSchedulesModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content modal-content-dark">
          <div class="modal-header border-0">
            <h4 class="modal-title fw-bold">Medication Schedules</h4>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
             <div id="medicationScheduleList">Loading...</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 4. SUB-MODAL: Medication Schedule -->
    <div class="modal fade" id="medicationScheduleModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-content-dark p-3">
          <div id="medicationSaveOverlay" class="save-overlay d-none">
            <i class="bi bi-check-circle-fill save-icon"></i>
            <div class="save-text">Saved!</div>
          </div>
          <div class="modal-header border-0 pb-0">
             <!-- Back button updated to toggle main modal -->
             <button type="button" class="btn text-white p-0" data-bs-target="#patientDetailModal" data-bs-toggle="modal">
               <i class="bi bi-arrow-left fs-2"></i>
             </button>
          </div>
          <div class="modal-body pt-2">
            <h4 class="fw-bold mb-2">Medication Schedule</h4>
            <p class="text-white-50 mb-4">Add schedule for patient</p>
            
            <div id="medicationContainer">
              <!-- Dynamic Rows will be added here -->
              <div class="medication-group">
                <div class="mb-3">
                   <label class="form-label-light">Time</label>
                   <input type="time" class="form-control form-control-pill-white sched-time">
                </div>
                <div class="mb-3">
                   <label class="form-label-light">Medication Name</label>
                   <input type="text" class="form-control form-control-pill-white sched-name">
                </div>
              </div>
            </div>

            <!-- Add Another Button -->
            <button class="btn btn-sm btn-outline-light mb-4" onclick="addMedicationGroup()">
                <i class="bi bi-plus-circle me-1"></i> Add Another
            </button>

            <button class="btn-register-submit" onclick="saveMedicationSchedule()">Save Schedule</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 5. SUB-MODAL: Blood Pressure -->
    <div class="modal fade" id="bloodPressureModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-content-dark p-3">
          <div id="bpSaveOverlay" class="save-overlay d-none">
            <i class="bi bi-check-circle-fill save-icon"></i>
            <div class="save-text">Saved!</div>
          </div>
          <div class="modal-header border-0 pb-0">
             <!-- Back button updated to toggle main modal -->
             <button type="button" class="btn text-white p-0" data-bs-target="#patientDetailModal" data-bs-toggle="modal">
               <i class="bi bi-arrow-left fs-2"></i>
             </button>
          </div>
          <div class="modal-body pt-2">
            <h4 class="fw-bold mb-2">BP Records</h4>
            <p class="text-white-50 mb-4">Log blood pressure</p>
            <div class="mb-3">
               <label class="form-label-light">Systolic</label>
               <input type="number" id="bpSystolic" class="form-control form-control-pill-white">
            </div>
            <div class="mb-3">
               <label class="form-label-light">Diastolic</label>
               <input type="number" id="bpDiastolic" class="form-control form-control-pill-white">
            </div>
            <button class="btn-register-submit" onclick="saveBPRecord()">Save BP</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 6. SUB-MODAL: Pharmacy Notes -->
    <div class="modal fade" id="pharmacyNotesModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-content-dark p-3">
          <div id="pharmacySaveOverlay" class="save-overlay d-none">
            <i class="bi bi-check-circle-fill save-icon"></i>
            <div class="save-text">Saved!</div>
          </div>
          <div class="modal-header border-0 pb-0">
             <!-- Back button updated to toggle main modal -->
             <button type="button" class="btn text-white p-0" data-bs-target="#patientDetailModal" data-bs-toggle="modal">
               <i class="bi bi-arrow-left fs-2"></i>
             </button>
          </div>
          <div class="modal-body pt-2">
            <h4 class="fw-bold mb-2">Pharmacy Notes</h4>
            <div class="mb-3">
               <textarea id="pharmacyNoteInput" class="form-control form-control-pill-white" rows="5" placeholder="Enter notes..."></textarea>
            </div>
            <button class="btn-register-submit" onclick="savePharmacyNote()">Save Note</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 7. SUB-MODAL: Add Medical Checkup -->
    <div class="modal fade" id="medicalCheckupRecordsModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-content-dark p-3">
          <div id="checkupSaveOverlay" class="save-overlay d-none">
            <i class="bi bi-check-circle-fill save-icon"></i>
            <div class="save-text">Saved!</div>
          </div>
          <div class="modal-header border-0 pb-0">
             <!-- Back button updated to toggle main modal -->
             <button type="button" class="btn text-white p-0" data-bs-target="#patientDetailModal" data-bs-toggle="modal">
               <i class="bi bi-arrow-left fs-2"></i>
             </button>
          </div>
          <div class="modal-body pt-2">
            <h4 class="fw-bold mb-2">Add Medical Record</h4>
            <div class="row">
               <div class="col-6 mb-3"><input type="number" id="chkSys" class="form-control form-control-pill-white" placeholder="Sys"></div>
               <div class="col-6 mb-3"><input type="number" id="chkDia" class="form-control form-control-pill-white" placeholder="Dia"></div>
            </div>
            <div class="mb-3"><input type="text" id="chkMeds" class="form-control form-control-pill-white" placeholder="Medication"></div>
            <div class="mb-3"><input type="text" id="chkNotes" class="form-control form-control-pill-white" placeholder="Notes"></div>
            <button class="btn-register-submit" onclick="saveNewCheckup()">Save Record</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 8. SUB-MODAL: View History -->
    <div class="modal fade" id="medicalCheckupModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content modal-content-dark p-3">
          <div class="modal-header border-0">
             <!-- Back button updated to toggle main modal (added back arrow here too for consistency) -->
             <button type="button" class="btn text-white p-0 me-3" data-bs-target="#patientDetailModal" data-bs-toggle="modal">
               <i class="bi bi-arrow-left fs-2"></i>
             </button>
             <h4 class="modal-title fw-bold">History</h4>
             <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
             <div id="checkupHistoryList">Loading...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    
    <script>
      const db = firebase.firestore();
      const auth = firebase.auth();
      const patientListContainer = document.getElementById('patientListContainer');
      const loadingSpinner = document.getElementById('loadingSpinner');
      let allPatients = []; 
      let currentPatientId = null; // Tracks which patient card was clicked

      // Service Worker Registration
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/service-worker.js')
            .then(registration => {
                console.log('Service Worker registered with scope:', registration.scope);
            })
            .catch(error => {
                console.error('Service Worker registration failed:', error);
            });
      }

      // Request Notification Permission
      function requestNotificationPermission() {
        if (!("Notification" in window)) {
            alert("This browser does not support desktop notification");
        } else if (Notification.permission === "granted") {
            console.log("Notification permission already granted.");
            return true;
        } else if (Notification.permission !== "denied") {
            return Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    console.log("Notification permission granted.");
                    return true;
                } else {
                    console.log("Notification permission denied.");
                    return false;
                }
            });
        }
        return false;
      }

      // Schedule Notifications
      async function scheduleNotifications(patientId) {
        const hasPermission = await requestNotificationPermission();
        if (!hasPermission) {
            console.log("No permission to send notifications.");
            return;
        }

        const schedulesSnapshot = await db.collection("users").doc(patientId).collection("medication_schedules").get();
        if (schedulesSnapshot.empty) {
            console.log("No medication schedules found for this patient.");
            return;
        }

        schedulesSnapshot.forEach(doc => {
            const schedule = doc.data();
            if (schedule.items && Array.isArray(schedule.items)) {
                schedule.items.forEach(item => {
                    const [hour, minute] = item.time.split(':');
                    const now = new Date();
                    let notificationTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, minute);

                    // If the time is in the past for today, schedule it for tomorrow
                    if (notificationTime < now) {
                        notificationTime.setDate(notificationTime.getDate() + 1);
                    }

                    const delay = notificationTime.getTime() - now.getTime();

                    if (delay > 0) {
                        navigator.serviceWorker.ready.then(registration => {
                            registration.active.postMessage({
                                type: 'SCHEDULE_NOTIFICATION',
                                delay: delay,
                                options: {
                                    body: `Time to take ${item.medication}`,
                                    icon: '/Assets/logo.png',
                                    data: {
                                        url: window.location.href
                                    }
                                }
                            });
                        });
                        console.log(`Notification scheduled for ${item.medication} at ${notificationTime}`);
                    }
                });
            }
        });
      }

      // 1. Check Auth
      auth.onAuthStateChanged((user) => {
        if (user) {
          document.getElementById('user-email').textContent = user.email;
          loadPatients();
        } else {
          console.warn("User NOT logged in.");
          loadPatients(); 
        }
      });

      // 2. Logout
      document.getElementById('logout-button').addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('logoutConfirmContent').classList.remove('d-none');
        document.getElementById('logoutLoadingContent').classList.add('d-none');
        new bootstrap.Modal(document.getElementById('logoutModal')).show();
      });

      document.getElementById('confirmLogoutBtn').addEventListener('click', () => {
        document.getElementById('logoutConfirmContent').classList.add('d-none');
        document.getElementById('logoutLoadingContent').classList.remove('d-none');
        setTimeout(() => {
            auth.signOut().then(() => window.location.href = 'index.html');
        }, 1500);
      });

      // 3. Load Patients
      async function loadPatients() {
        try {
            const q = db.collection("users").where("role", "==", "patient");
            const querySnapshot = await q.get();
            
            loadingSpinner.style.display = 'none'; 
            patientListContainer.innerHTML = ''; 
            allPatients = [];

            if (querySnapshot.empty) {
                patientListContainer.innerHTML = '<p class="text-center text-white-50 mt-4">No patients found.</p>';
                return;
            }

            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const patientData = { id: doc.id, ...data };
                allPatients.push(patientData);
                renderPatientCard(patientData);
            });

        } catch (error) {
            console.error("Error: ", error);
            loadingSpinner.style.display = 'none';
            if(error.code === 'permission-denied') {
                patientListContainer.innerHTML = '<p class="text-center text-danger mt-4">Permission Denied: Check Firestore Rules.</p>';
            }
        }
      }

      // 4. Render Card (Now opens Modal instead of Redirect)
      function renderPatientCard(patient) {
          const name = patient.username || "Unknown";
          const age = patient.age || "N/A";
          const condition = patient.medical_report || "No Data";
          const initial = name.charAt(0).toUpperCase();

          // CHANGED: onclick calls openPatientDetail()
          const cardHTML = `
            <div class="patient-card" onclick="openPatientDetail('${patient.id}')">
              <div class="patient-avatar">${initial}</div>
              <div class="patient-info">
                <div class="patient-name">${name}</div>
                <div class="patient-meta">Age: ${age}</div>
                <div class="patient-condition">${condition}</div>
              </div>
            </div>
          `;
          patientListContainer.insertAdjacentHTML('beforeend', cardHTML);
      }

      // 5. Open Patient Detail Modal
      function openPatientDetail(id) {
          currentPatientId = id; // Set global ID
          const patient = allPatients.find(p => p.id === id);
          
          if(patient) {
              // Populate Modal Fields
              document.getElementById('modalPName').innerText = `${patient.username || 'Unknown'} (${patient.age || 'N/A'})`;
              
              // Populate view mode
              document.getElementById('modalPLocDob').innerText = patient.location_dob || 'N/A';
              document.getElementById('modalPReport').innerText = patient.medical_report || 'N/A';
              document.getElementById('modalPAllergies').innerText = patient.allergies || 'N/A';
              document.getElementById('modalPMeds').innerText = patient.medication || 'N/A';

              // Ensure edit mode is off by default
              toggleEditMode(false);
              
              // Show Modal
              new bootstrap.Modal(document.getElementById('patientDetailModal')).show();
              scheduleNotifications(id);
          }
      }

      function toggleEditMode(editing) {
        const viewDiv = document.getElementById('patient-details-view');
        const editDiv = document.getElementById('patient-details-edit');
        const editBtn = document.getElementById('editPatientBtn');
        const saveBtn = document.getElementById('savePatientBtn');
        const cancelBtn = document.getElementById('cancelEditBtn');

        if (editing) {
          // Populate edit fields
          const patient = allPatients.find(p => p.id === currentPatientId);
          if (patient) {
            document.getElementById('editPLocDob').value = patient.location_dob || '';
            document.getElementById('editPReport').value = patient.medical_report || '';
            document.getElementById('editPAllergies').value = patient.allergies || '';
            document.getElementById('editPMeds').value = patient.medication || '';
          }

          viewDiv.classList.add('d-none');
          editDiv.classList.remove('d-none');
          editBtn.classList.add('d-none');
          saveBtn.classList.remove('d-none');
          cancelBtn.classList.remove('d-none');
        } else {
          viewDiv.classList.remove('d-none');
          editDiv.classList.add('d-none');
          editBtn.classList.remove('d-none');
          saveBtn.classList.add('d-none');
          cancelBtn.classList.add('d-none');
        }
      }

      async function savePatientDetails() {
        if (!currentPatientId) return;

        const updatedData = {
          location_dob: document.getElementById('editPLocDob').value,
          medical_report: document.getElementById('editPReport').value,
          allergies: document.getElementById('editPAllergies').value,
          medication: document.getElementById('editPMeds').value,
        };

        const user = auth.currentUser;
        if (!user) {
          alert("You must be logged in to make changes.");
          return;
        }

        const batch = db.batch();
        const patientRef = db.collection("users").doc(currentPatientId);
        batch.update(patientRef, updatedData);

        const auditTrailRef = patientRef.collection("audit_trail").doc();
        batch.set(auditTrailRef, {
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          changedBy: user.email,
          changeType: "Updated Patient Details",
          changeDetails: updatedData
        });

        try {
          await batch.commit();
          
          // Update local data
          const patientIndex = allPatients.findIndex(p => p.id === currentPatientId);
          if (patientIndex > -1) {
            allPatients[patientIndex] = { ...allPatients[patientIndex], ...updatedData };
          }
          
          // Update view
          document.getElementById('modalPLocDob').innerText = updatedData.location_dob;
          document.getElementById('modalPReport').innerText = updatedData.medical_report;
          document.getElementById('modalPAllergies').innerText = updatedData.allergies;
          document.getElementById('modalPMeds').innerText = updatedData.medication;

          toggleEditMode(false);
          alert('Patient details updated successfully!');
        } catch (error) {
          console.error("Error updating patient details:", error);
          alert("Error: " + error.message);
        }
      }

      // 6. Sub-Modal Saving Logic
      function showOverlayAndClose(modalId, overlayId) {
        const overlay = document.getElementById(overlayId);
        const modalEl = document.getElementById(modalId);
        const modal = bootstrap.Modal.getInstance(modalEl);
        overlay.classList.remove('d-none');
        setTimeout(() => {
          overlay.classList.add('d-none');
          modal.hide();
          // Return to main
          new bootstrap.Modal(document.getElementById('patientDetailModal')).show();
        }, 1500);
      }

      async function saveBPRecord() {
         if(!currentPatientId) return;

         const user = auth.currentUser;
         if (!user) {
           alert("You must be logged in to make changes.");
           return;
         }

         const sys = document.getElementById('bpSystolic').value;
         const dia = document.getElementById('bpDiastolic').value;

         const batch = db.batch();
         const patientRef = db.collection("users").doc(currentPatientId);

         const bpRef = patientRef.collection("blood_pressure").doc();
         batch.set(bpRef, {
             systolic: sys, diastolic: dia, recordedAt: firebase.firestore.FieldValue.serverTimestamp()
         });

         const auditTrailRef = patientRef.collection("audit_trail").doc();
         batch.set(auditTrailRef, {
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          changedBy: user.email,
          changeType: "Added Blood Pressure Record",
          changeDetails: { systolic: sys, diastolic: dia }
         });

         try {
             await batch.commit();
             showOverlayAndClose('bloodPressureModal', 'bpSaveOverlay');
         } catch(e) { alert("Error: " + e.message); }
      }

      function addMedicationGroup() {
        const container = document.getElementById('medicationContainer');
        const div = document.createElement('div');
        div.className = 'medication-group';
        div.innerHTML = `
            <div class="mb-3">
               <label class="form-label-light">Time</label>
               <input type="time" class="form-control form-control-pill-white sched-time">
            </div>
            <div class="mb-3">
               <label class="form-label-light">Medication Name</label>
               <input type="text" class="form-control form-control-pill-white sched-name">
            </div>
        `;
        container.appendChild(div);
      }

      async function saveMedicationSchedule() {
         if(!currentPatientId) return;

         const user = auth.currentUser;
         if (!user) {
           alert("You must be logged in to make changes.");
           return;
         }
         
         const groups = document.querySelectorAll('.medication-group');
         const schedules = [];
         
         groups.forEach(g => {
             const time = g.querySelector('.sched-time').value;
             const name = g.querySelector('.sched-name').value;
             if(time && name) {
                 schedules.push({ time, medication: name });
             }
         });

         if(schedules.length === 0) return alert("Add at least one medication.");

         // Create Google Calendar events if authorized
         if (gapi.client.getToken() !== null) {
            const patient = allPatients.find(p => p.id === currentPatientId);
            const patientName = patient ? patient.username : 'Unknown Patient';
            schedules.forEach(schedule => {
              createCalendarEvent(schedule, patientName);
            });
         }

         const batch = db.batch();
         const patientRef = db.collection("users").doc(currentPatientId);
         
         const scheduleRef = patientRef.collection("medication_schedules").doc();
         batch.set(scheduleRef, {
             items: schedules,
             createdAt: firebase.firestore.FieldValue.serverTimestamp()
         });

         const auditTrailRef = patientRef.collection("audit_trail").doc();
         batch.set(auditTrailRef, {
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          changedBy: user.email,
          changeType: "Added Medication Schedule",
          changeDetails: { items: schedules }
         });

         try {
             await batch.commit();
             showOverlayAndClose('medicationScheduleModal', 'medicationSaveOverlay');
             
             document.getElementById('medicationContainer').innerHTML = `
              <div class="medication-group">
                <div class="mb-3">
                   <label class="form-label-light">Time</label>
                   <input type="time" class="form-control form-control-pill-white sched-time">
                </div>
                <div class="mb-3">
                   <label class="form-label-light">Medication Name</label>
                   <input type="text" class="form-control form-control-pill-white sched-name">
                </div>
              </div>
             `;
         } catch(e) { alert("Error: " + e.message); }
      }

      async function createCalendarEvent(schedule, patientName) {
        const [hour, minute] = schedule.time.split(':');
        const now = new Date();
        // Schedule for the next day
        const eventDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, hour, minute);

        const event = {
          'summary': `Take ${schedule.medication} for ${patientName}`,
          'description': `Medication reminder for ${patientName} to take ${schedule.medication}.`,
          'start': {
            'dateTime': eventDate.toISOString(),
            'timeZone': 'Asia/Jakarta'
          },
          'end': {
            'dateTime': eventDate.toISOString(),
            'timeZone': 'Asia/Jakarta'
          },
          'reminders': {
            'useDefault': false,
            'overrides': [
              {'method': 'email', 'minutes': 0},
              {'method': 'popup', 'minutes': 0}
            ]
          }
        };

        try {
          const request = gapi.client.calendar.events.insert({
            'calendarId': 'primary',
            'resource': event
          });
          const response = await request;
          console.log('Event created: ' + response.result.htmlLink);
        } catch (error) {
          console.error('Error creating event: ', error);
        }
      }

      async function savePharmacyNote() {
         if(!currentPatientId) return;

         const user = auth.currentUser;
         if (!user) {
           alert("You must be logged in to make changes.");
           return;
         }

         const note = document.getElementById('pharmacyNoteInput').value;

         const batch = db.batch();
         const patientRef = db.collection("users").doc(currentPatientId);

         const noteRef = patientRef.collection("pharmacy_notes").doc();
         batch.set(noteRef, {
             note: note, createdAt: firebase.firestore.FieldValue.serverTimestamp()
         });

         const auditTrailRef = patientRef.collection("audit_trail").doc();
         batch.set(auditTrailRef, {
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          changedBy: user.email,
          changeType: "Added Pharmacy Note",
          changeDetails: { note: note }
         });

         try {
             await batch.commit();
             showOverlayAndClose('pharmacyNotesModal', 'pharmacySaveOverlay');
         } catch(e) { alert("Error: " + e.message); }
      }

      async function saveNewCheckup() {
         if(!currentPatientId) return;

         const user = auth.currentUser;
         if (!user) {
           alert("You must be logged in to make changes.");
           return;
         }

         const sys = document.getElementById('chkSys').value;
         const dia = document.getElementById('chkDia').value;
         const meds = document.getElementById('chkMeds').value;
         const notes = document.getElementById('chkNotes').value;
         
         const checkupData = {
             bp: `${sys}/${dia}`, medication: meds, notes: notes, date: firebase.firestore.FieldValue.serverTimestamp()
         };

         const batch = db.batch();
         const patientRef = db.collection("users").doc(currentPatientId);

         const checkupRef = patientRef.collection("checkup_records").doc();
         batch.set(checkupRef, checkupData);

         const auditTrailRef = patientRef.collection("audit_trail").doc();
         batch.set(auditTrailRef, {
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          changedBy: user.email,
          changeType: "Added Medical Checkup Record",
          changeDetails: checkupData
         });

         try {
             await batch.commit();
             showOverlayAndClose('medicalCheckupRecordsModal', 'checkupSaveOverlay');
         } catch(e) { alert("Error: " + e.message); }
      }

      function formatChangeDetails(changeType, changeDetails) {
        let formatted = '';
        switch (changeType) {
          case "Updated Patient Details":
            formatted += '<ul>';
            for (const key in changeDetails) {
              if (Object.hasOwnProperty.call(changeDetails, key)) {
                formatted += `<li><strong>${key.replace(/_/g, ' ')}:</strong> ${changeDetails[key]}</li>`;
              }
            }
            formatted += '</ul>';
            break;
          case "Added Medication Schedule":
            formatted += '<ul>';
            changeDetails.items.forEach(item => {
              formatted += `<li>${item.time} - ${item.medication}</li>`;
            });
            formatted += '</ul>';
            break;
          case "Added Blood Pressure Record":
            formatted += `<p><strong>Systolic:</strong> ${changeDetails.systolic}, <strong>Diastolic:</strong> ${changeDetails.diastolic}</p>`;
            break;
          case "Added Pharmacy Note":
            formatted += `<p><strong>Note:</strong> ${changeDetails.note}</p>`;
            break;
          case "Added Medical Checkup Record":
            formatted += `<p><strong>BP:</strong> ${changeDetails.bp}, <strong>Medication:</strong> ${changeDetails.medication}, <strong>Notes:</strong> ${changeDetails.notes}</p>`;
            break;
          default:
            formatted = `<pre><small>${JSON.stringify(changeDetails, null, 2)}</small></pre>`;
            break;
        }
        return formatted;
      }

      function openViewMedicationSchedules() {
          if(!currentPatientId) return;
          const list = document.getElementById('medicationScheduleList');
          list.innerHTML = 'Loading...';
          
          db.collection("users").doc(currentPatientId).collection("medication_schedules").orderBy('createdAt','desc').get()
          .then(snap => {
              if(snap.empty) { list.innerHTML = "No medication schedules found."; return; }
              let html = '<ul class="list-group">';
              snap.forEach(doc => {
                  const d = doc.data();
                  const dateStr = d.createdAt ? d.createdAt.toDate().toLocaleString() : '?';
                  let itemsHtml = '<ul class="list-unstyled mt-2">';
                  if(d.items && Array.isArray(d.items)) {
                    d.items.forEach(item => {
                      let scheduleInfo = `${item.time} - ${item.medication}`;
                      if (item.startDate && item.endDate) {
                        scheduleInfo += ` (from ${item.startDate} to ${item.endDate})`;
                      }
                      itemsHtml += `<li>${scheduleInfo}</li>`;
                    });
                  }
                  itemsHtml += '</ul>';

                  html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                              <div>
                                <small>Scheduled on: ${dateStr}</small>
                                ${itemsHtml}
                              </div>
                              <button class="btn btn-danger btn-sm" onclick="deleteMedicationSchedule('${doc.id}')">Delete</button>
                           </li>`;
              });
              html += '</ul>';
              list.innerHTML = html;
              new bootstrap.Modal(document.getElementById('viewMedicationSchedulesModal')).show();
          });
      }

      async function deleteMedicationSchedule(scheduleId) {
        if (!currentPatientId || !scheduleId) return;
        if (confirm("Are you sure you want to delete this medication schedule?")) {
          try {
            await db.collection("users").doc(currentPatientId).collection("medication_schedules").doc(scheduleId).delete();
            alert("Schedule deleted successfully!");
            openViewMedicationSchedules(); // Refresh the list
          } catch (error) {
            console.error("Error deleting schedule: ", error);
            alert("Error: " + error.message);
          }
        }
      }

      function openCheckupHistory() {
          if(!currentPatientId) return;
          const list = document.getElementById('checkupHistoryList');
          list.innerHTML = 'Loading...';
          
          db.collection("users").doc(currentPatientId).collection("checkup_records").orderBy('date','desc').get()
          .then(snap => {
              const modalTitle = document.querySelector('#medicalCheckupModal .modal-title');
              if (modalTitle) modalTitle.innerText = "Medical Checkup Records";

              if(snap.empty) { 
                list.innerHTML = '<p class="text-center text-white-50">No checkup records found.</p>'; 
              } else {
                let html = '<div class="list-group">';
                snap.forEach(doc => {
                    const d = doc.data();
                    const dateStr = d.date ? d.date.toDate().toLocaleString() : 'N/A';
                    const bp = d.bp || 'N/A';
                    const medication = d.medication || 'N/A';
                    const notes = d.notes || 'N/A';

                    html += `<div class="list-group-item list-group-item-action flex-column align-items-start bg-light text-dark mb-2 rounded-3 border-0">
                                <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1 fw-bold text-primary">Checkup on ${dateStr}</h5>
                                </div>
                                <p class="mb-1"><strong>Blood Pressure:</strong> ${bp}</p>
                                <p class="mb-1"><strong>Medication:</strong> ${medication}</p>
                                <small><strong>Notes:</strong> ${notes}</small>
                            </div>`;
                });
                html += '</div>';
                list.innerHTML = html;
              }

              new bootstrap.Modal(document.getElementById('medicalCheckupModal')).show();
          })
          .catch(error => {
              console.error("Error fetching checkup records: ", error);
              list.innerHTML = '<p class="text-center text-danger">Error loading records.</p>';
              new bootstrap.Modal(document.getElementById('medicalCheckupModal')).show();
          });
      }

      // 7. Register Logic (Existing)
      const registerForm = document.getElementById('registerForm');
      registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!auth.currentUser) { alert("Login required."); return; }
        
        const newPatient = {
            username: document.getElementById('regName').value,
            age: document.getElementById('regAge').value,
            location_dob: document.getElementById('regLocation').value,
            medical_report: document.getElementById('regReport').value,
            allergies: document.getElementById('regAllergies').value,
            medication: document.getElementById('regMedication').value,
            role: 'patient', 
            email: 'patient@hypercare.com', 
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            await db.collection("users").add(newPatient);
            bootstrap.Modal.getInstance(document.getElementById('registerPatientModal')).hide();
            registerForm.reset();
            loadPatients(); 
            alert("Registered!");
        } catch (error) {
            alert("Error: " + error.message);
        }
      });

      // 8. Search Logic
      document.getElementById('searchInput').addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        patientListContainer.innerHTML = '';
        const filtered = allPatients.filter(p => p.username && p.username.toLowerCase().includes(term));
        if (filtered.length === 0) patientListContainer.innerHTML = '<p class="text-center text-white-50">No matches.</p>';
        else filtered.forEach(p => renderPatientCard(p));
      });

      const CLIENT_ID = '387519648442-fv232sn74e1a6i5g88fq2r17693p43jh.apps.googleusercontent.com';
      const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];
      const SCOPES = "https://www.googleapis.com/auth/calendar.events";

      let tokenClient;
      let gapiInited = false;
      let gisInited = false;

      document.getElementById('authorize_button').style.visibility = 'hidden';
      document.getElementById('signout_button').style.visibility = 'hidden';

      function gapiLoaded() {
        gapi.load('client', initializeGapiClient);
      }

      async function initializeGapiClient() {
        await gapi.client.init({
          discoveryDocs: DISCOVERY_DOCS,
        });
        gapiInited = true;
        maybeEnableButtons();
      }

      function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: '', // defined later
        });
        gisInited = true;
        maybeEnableButtons();
      }

      function maybeEnableButtons() {
        if (gapiInited && gisInited) {
          document.getElementById('authorize_button').style.visibility = 'visible';
        }
      }

      document.getElementById('authorize_button').onclick = handleAuthClick;
      document.getElementById('signout_button').onclick = handleSignoutClick;

      function handleAuthClick() {
        tokenClient.callback = async (resp) => {
          if (resp.error !== undefined) {
            throw (resp);
          }
          document.getElementById('signout_button').style.visibility = 'visible';
          document.getElementById('authorize_button').innerText = 'Refresh';
          await listUpcomingEvents();
        };

        if (gapi.client.getToken() === null) {
          tokenClient.requestAccessToken({prompt: 'consent'});
        } else {
          tokenClient.requestAccessToken({prompt: ''});
        }
      }

      function handleSignoutClick() {
        const token = gapi.client.getToken();
        if (token !== null) {
          google.accounts.oauth2.revoke(token.access_token);
          gapi.client.setToken('');
          document.getElementById('authorize_button').innerText = 'Authorize';
          document.getElementById('signout_button').style.visibility = 'hidden';
        }
      }

      async function listUpcomingEvents() {
        let response;
        try {
          const request = {
            'calendarId': 'primary',
            'timeMin': (new Date()).toISOString(),
            'showDeleted': false,
            'singleEvents': true,
            'maxResults': 10,
            'orderBy': 'startTime',
          };
          response = await gapi.client.calendar.events.list(request);
        } catch (err) {
          console.error('Error getting events: ', err);
          return;
        }

        const events = response.result.items;
        if (!events || events.length == 0) {
          console.log('No upcoming events found.');
          return;
        }
        // Flatten to string to display
        const output = events.reduce(
            (str, event) => `${str}${event.summary} (${(event.start.dateTime || event.start.date)})\n`,
            'Events:\n');
        console.log(output);
      }
    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
  </body>
</html>
