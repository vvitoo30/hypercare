<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Dashboard - Hypercare</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <!-- Google Font: Poppins -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Custom CSS -->
    <style>
      /* --- BASE THEME --- */
      body {
        font-family: "Poppins", sans-serif;
        background-color: #1c1c3a; /* Deep Dark Blue */
        color: white;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      /* --- HEADER --- */
      .navbar-custom {
        background-color: #15152e;
        padding: 1rem 0;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      }
      .brand-logo {
        font-weight: 700;
        font-size: 1.5rem;
        color: white;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      
      /* --- STATS CARDS --- */
      .stat-card {
        background: linear-gradient(145deg, #2a2a55, #212145);
        border-radius: 1.5rem;
        padding: 1.5rem;
        border: 1px solid rgba(255,255,255,0.05);
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: all 0.2s;
        cursor: pointer; /* Clickable cursor */
        position: relative;
        overflow: hidden;
      }
      .stat-card:hover {
        transform: translateY(-5px);
        border-color: #4a43d1;
        box-shadow: 0 10px 20px rgba(0,0,0,0.2);
      }
      .stat-card.active-filter {
        border: 2px solid #ffffff;
        background: #343461;
      }
      
      .stat-icon-box {
        width: 50px;
        height: 50px;
        border-radius: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        flex-shrink: 0;
      }
      /* Specific Colors for Stats */
      .stat-users .stat-icon-box { background-color: rgba(74, 67, 209, 0.2); color: #4a43d1; }
      .stat-doctors .stat-icon-box { background-color: rgba(13, 202, 240, 0.2); color: #0dcaf0; }
      .stat-patients .stat-icon-box { background-color: rgba(25, 135, 84, 0.2); color: #198754; }
      .stat-admins .stat-icon-box { background-color: rgba(220, 53, 69, 0.2); color: #dc3545; }

      /* --- TABLE SECTION --- */
      .table-container {
        background-color: #ffffff;
        border-radius: 1.5rem;
        padding: 2rem;
        color: #333;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      }
      
      .custom-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 1rem; /* Spacing between rows */
      }
      
      .custom-table thead th {
        border: none;
        color: #888;
        font-weight: 600;
        font-size: 0.9rem;
        text-transform: uppercase;
        padding: 0 1rem;
      }

      .custom-table tbody tr {
        background-color: #f8f9fa;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        transition: transform 0.1s;
      }
      .custom-table tbody tr:hover {
        transform: scale(1.01);
        background-color: #f0f4ff; /* Light blue hover */
      }

      .custom-table td {
        padding: 1.2rem 1rem;
        vertical-align: middle;
        border: none;
      }
      
      /* Round corners for first and last cells */
      .custom-table td:first-child { border-top-left-radius: 1rem; border-bottom-left-radius: 1rem; }
      .custom-table td:last-child { border-top-right-radius: 1rem; border-bottom-right-radius: 1rem; }

      /* User Avatar in Table */
      .table-avatar {
        width: 40px;
        height: 40px;
        background-color: #4a43d1;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 1rem;
      }

      /* Role Select Input */
      .role-select {
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 2rem;
        padding: 0.4rem 1rem;
        font-size: 0.9rem;
        color: #4a43d1;
        font-weight: 600;
        cursor: pointer;
      }
      .role-select:focus {
        border-color: #4a43d1;
        outline: none;
        box-shadow: 0 0 0 2px rgba(74, 67, 209, 0.2);
      }

      /* Role Badges */
      .badge-role {
        padding: 0.4rem 0.8rem;
        border-radius: 2rem;
        font-size: 0.8rem;
        font-weight: 600;
      }
      .badge-admin { background-color: #ffe0e3; color: #dc3545; }
      .badge-doctor { background-color: #e0f8ff; color: #0dcaf0; }
      .badge-patient { background-color: #d1e7dd; color: #198754; }
      .badge-user { background-color: #e2e3e5; color: #6c757d; }

      /* Delete Button */
      .btn-delete {
        background-color: #ffe0e3;
        color: #dc3545;
        border: none;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }
      .btn-delete:hover {
        background-color: #dc3545;
        color: white;
      }

      /* --- MODAL (Dark Theme) --- */
      .modal-content-dark {
        background-color: #252547;
        color: white;
        border-radius: 1.5rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
    </style>
  </head>
  <body>

    <!-- Header -->
    <nav class="navbar-custom">
      <div class="container d-flex justify-content-between align-items-center">
        <a href="#" class="brand-logo">
            <i class="bi bi-shield-lock-fill text-primary"></i>
            Hypercare Admin
        </a>
        
        <div class="dropdown">
            <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle" data-bs-toggle="dropdown">
              <div class="rounded-circle bg-secondary me-2 d-flex align-items-center justify-content-center" style="width: 35px; height: 35px;">
                <i class="bi bi-person-fill"></i>
              </div>
              <span class="d-none d-sm-block">Admin</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark shadow">
              <li><a class="dropdown-item" href="#" id="logoutBtn"><i class="bi bi-box-arrow-right me-2"></i>Log Out</a></li>
            </ul>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="container mt-5 pb-5">
      
      <!-- Stats Section (Click to Filter) -->
      <div class="row g-3 mb-5">
        <div class="col-6 col-md-3">
          <div class="stat-card stat-users active-filter" id="card-all" onclick="applyFilter('all')">
            <div class="stat-icon-box"><i class="bi bi-people-fill"></i></div>
            <div>
              <h2 class="fw-bold m-0" id="totalUsersCount">0</h2>
              <p class="text-white-50 m-0 small">Total</p>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="stat-card stat-doctors" id="card-doctor" onclick="applyFilter('doctor')">
            <div class="stat-icon-box"><i class="bi bi-heart-pulse-fill"></i></div>
            <div>
              <h2 class="fw-bold m-0" id="totalDoctorsCount">0</h2>
              <p class="text-white-50 m-0 small">Doctors</p>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="stat-card stat-patients" id="card-patient" onclick="applyFilter('patient')">
            <div class="stat-icon-box"><i class="bi bi-person-wheelchair"></i></div>
            <div>
              <h2 class="fw-bold m-0" id="totalPatientsCount">0</h2>
              <p class="text-white-50 m-0 small">Patients</p>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="stat-card stat-admins" id="card-admin" onclick="applyFilter('admin')">
            <div class="stat-icon-box"><i class="bi bi-shield-fill"></i></div>
            <div>
              <h2 class="fw-bold m-0" id="totalAdminsCount">0</h2>
              <p class="text-white-50 m-0 small">Admins</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Table Section -->
      <div class="table-container">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3 class="fw-bold m-0">Manage Users</h3>
          <div style="width: 250px; position: relative;">
            <input type="text" id="searchUser" class="form-control rounded-pill ps-4" placeholder="Search users...">
            <i class="bi bi-search position-absolute text-muted" style="right: 15px; top: 10px;"></i>
          </div>
        </div>

        <div class="table-responsive">
          <table class="custom-table">
            <thead>
              <tr>
                <th>User</th>
                <th>Email</th>
                <th>Current Role</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="userTableBody">
               <tr>
                   <td colspan="4" class="text-center py-4">Loading users...</td>
               </tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>

    <!-- ============ MODALS ============ -->

    <!-- 1. Logout Modal -->
    <div class="modal fade" id="logoutModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-content-dark p-4 text-center">
          <div class="modal-body p-0">
            <div id="logoutConfirmContent">
              <div class="mb-4">
                <div class="mx-auto d-flex align-items-center justify-content-center rounded-circle" style="width: 80px; height: 80px; background-color: rgba(74, 67, 209, 0.1);">
                  <i class="bi bi-box-arrow-right" style="font-size: 2.5rem; color: #4a43d1;"></i>
                </div>
              </div>
              <h3 class="fw-bold mb-2">Log Out</h3>
              <p class="text-white-50 mb-4">Are you sure you want to log out?</p>
              <div class="row g-3">
                <div class="col-6"><button type="button" class="btn btn-outline-light w-100 py-2 rounded-pill fw-bold" data-bs-dismiss="modal" style="border: 1px solid rgba(255,255,255,0.2);">Cancel</button></div>
                <div class="col-6"><button type="button" class="btn w-100 py-2 rounded-pill fw-bold" id="confirmLogoutBtn" style="background-color: #4a43d1; color: white;">Log Out</button></div>
              </div>
            </div>
            <div id="logoutLoadingContent" class="d-none py-3">
               <div class="spinner-border text-light mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
               <h4 class="fw-bold">Logging you out...</h4>
               <p class="text-white-50 m-0">Please be patient</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 2. Change Role Confirmation Modal -->
    <div class="modal fade" id="changeRoleModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content modal-content-dark p-4 text-center">
            <div class="modal-body p-0">
              <div id="roleConfirmContent">
                <div class="mb-4">
                  <div class="mx-auto d-flex align-items-center justify-content-center rounded-circle" style="width: 80px; height: 80px; background-color: rgba(255, 193, 7, 0.1);">
                    <i class="bi bi-exclamation-lg" style="font-size: 3rem; color: #ffc107;"></i>
                  </div>
                </div>
                <h3 class="fw-bold mb-2">Change Role?</h3>
                <p class="text-white-50 mb-4" id="roleChangeText">Are you sure?</p>
                <div class="row g-3">
                  <div class="col-6"><button type="button" class="btn btn-outline-light w-100 py-2 rounded-pill fw-bold" data-bs-dismiss="modal" style="border: 1px solid rgba(255,255,255,0.2);">Cancel</button></div>
                  <div class="col-6"><button type="button" class="btn w-100 py-2 rounded-pill fw-bold" id="confirmRoleChangeBtn" style="background-color: #ffc107; color: black;">Confirm</button></div>
                </div>
              </div>
              <!-- Loading State -->
              <div id="roleLoadingContent" class="d-none py-3">
                 <div class="spinner-border text-warning mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
                 <h4 class="fw-bold">Updating Role...</h4>
                 <p class="text-white-50 m-0">Please wait</p>
              </div>
            </div>
          </div>
        </div>
    </div>

    <!-- 3. Delete User Confirmation Modal -->
    <div class="modal fade" id="deleteUserModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content modal-content-dark p-4 text-center">
            <div class="modal-body p-0">
              <div id="deleteConfirmContent">
                <div class="mb-4">
                  <div class="mx-auto d-flex align-items-center justify-content-center rounded-circle" style="width: 80px; height: 80px; background-color: rgba(220, 53, 69, 0.1);">
                    <i class="bi bi-trash-fill" style="font-size: 2.5rem; color: #dc3545;"></i>
                  </div>
                </div>
                <h3 class="fw-bold mb-2">Delete User?</h3>
                <p class="text-white-50 mb-4" id="deleteUserText">This action cannot be undone.</p>
                <div class="row g-3">
                  <div class="col-6"><button type="button" class="btn btn-outline-light w-100 py-2 rounded-pill fw-bold" data-bs-dismiss="modal" style="border: 1px solid rgba(255,255,255,0.2);">Cancel</button></div>
                  <div class="col-6"><button type="button" class="btn w-100 py-2 rounded-pill fw-bold" id="confirmDeleteBtn" style="background-color: #dc3545; color: white;">Delete</button></div>
                </div>
              </div>
              <!-- Loading State -->
              <div id="deleteLoadingContent" class="d-none py-3">
                 <div class="spinner-border text-danger mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
                 <h4 class="fw-bold">Deleting User...</h4>
                 <p class="text-white-50 m-0">Please wait</p>
              </div>
            </div>
          </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
      const db = firebase.firestore();
      const auth = firebase.auth();
      let allUsers = [];
      let currentFilter = 'all';

      // Global variables for modals
      let targetUserId = null;
      let targetUserRole = null;
      let targetUserName = null;

      // 1. Auth Check
      auth.onAuthStateChanged(user => {
        if (user) {
            loadUsers();
        } else {
            // window.location.href = 'index.html'; // Uncomment in prod
            loadUsers(); // For testing
        }
      });

      // 2. Logout Logic
      document.getElementById('logoutBtn').addEventListener('click', (e) => {
          e.preventDefault();
          document.getElementById('logoutConfirmContent').classList.remove('d-none');
          document.getElementById('logoutLoadingContent').classList.add('d-none');
          new bootstrap.Modal(document.getElementById('logoutModal')).show();
      });

      document.getElementById('confirmLogoutBtn').addEventListener('click', () => {
          document.getElementById('logoutConfirmContent').classList.add('d-none');
          document.getElementById('logoutLoadingContent').classList.remove('d-none');
          setTimeout(() => {
              auth.signOut().then(() => window.location.href = 'index.html');
          }, 1500);
      });

      // 3. Load Users & Update Stats
      function loadUsers() {
          db.collection("users").onSnapshot(snapshot => {
              allUsers = [];
              let doctorCount = 0;
              let patientCount = 0;
              let adminCount = 0;

              snapshot.forEach(doc => {
                  const data = doc.data();
                  const user = { id: doc.id, ...data };
                  allUsers.push(user);

                  // Stats Logic
                  const r = (data.role || '').toLowerCase();
                  if(r === 'doctor') doctorCount++;
                  else if(r === 'patient') patientCount++;
                  else if(r === 'admin') adminCount++;
              });

              // Update Stats UI
              document.getElementById('totalUsersCount').innerText = allUsers.length;
              document.getElementById('totalDoctorsCount').innerText = doctorCount;
              document.getElementById('totalPatientsCount').innerText = patientCount;
              document.getElementById('totalAdminsCount').innerText = adminCount;

              // Re-apply current filter
              applyFilter(currentFilter);

          }, error => {
              console.error("Error fetching users:", error);
              alert("Error fetching users: " + error.message);
          });
      }

      // 4. Filter Logic
      function applyFilter(filterRole) {
          currentFilter = filterRole;
          
          document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active-filter'));
          document.getElementById(`card-${filterRole}`).classList.add('active-filter');

          const term = document.getElementById('searchUser').value.toLowerCase();
          
          const filtered = allUsers.filter(u => {
              const uRole = (u.role || 'user').toLowerCase();
              const roleMatch = (filterRole === 'all') || (uRole === filterRole);
              
              const nameMatch = (u.username && u.username.toLowerCase().includes(term)) || false;
              const emailMatch = (u.email && u.email.toLowerCase().includes(term)) || false;
              
              return roleMatch && (nameMatch || emailMatch || term === '');
          });

          renderTable(filtered);
      }

      // 5. Render Table
      function renderTable(users) {
          const tbody = document.getElementById('userTableBody');
          tbody.innerHTML = '';

          if (users.length === 0) {
              tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4">No users found matching this filter.</td></tr>';
              return;
          }

          users.forEach(user => {
              const name = user.username || 'Unknown';
              const email = user.email || '-';
              const role = user.role || 'user';
              const initial = name.charAt(0).toUpperCase();

              let badgeClass = 'badge-user';
              if(role === 'admin') badgeClass = 'badge-admin';
              if(role === 'doctor') badgeClass = 'badge-doctor';
              if(role === 'patient') badgeClass = 'badge-patient';

              const row = `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="table-avatar">${initial}</div>
                            <span class="fw-bold text-dark">${name}</span>
                        </div>
                    </td>
                    <td class="text-secondary">${email}</td>
                    <td><span class="badge-role ${badgeClass}">${role.toUpperCase()}</span></td>
                    <td class="d-flex align-items-center gap-2">
                        <select class="role-select" onchange="triggerRoleChange('${user.id}', this.value, '${name}')">
                            <option value="" disabled selected>Change Role</option>
                            <option value="patient">Patient</option>
                            <option value="doctor">Doctor</option>
                            <option value="admin">Admin</option>
                        </select>
                        <button class="btn-delete" onclick="triggerDeleteUser('${user.id}', '${name}')" title="Delete User">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
              `;
              tbody.insertAdjacentHTML('beforeend', row);
          });
      }

      // 6. Trigger Role Change Modal
      function triggerRoleChange(userId, newRole, userName) {
          targetUserId = userId;
          targetUserRole = newRole;
          targetUserName = userName;

          document.getElementById('roleChangeText').innerText = `Change role for "${userName}" to ${newRole.toUpperCase()}?`;
          
          // Reset Modal UI
          document.getElementById('roleConfirmContent').classList.remove('d-none');
          document.getElementById('roleLoadingContent').classList.add('d-none');
          
          new bootstrap.Modal(document.getElementById('changeRoleModal')).show();
      }

      // Handle Role Confirmation
      document.getElementById('confirmRoleChangeBtn').addEventListener('click', async () => {
          // Show loading
          document.getElementById('roleConfirmContent').classList.add('d-none');
          document.getElementById('roleLoadingContent').classList.remove('d-none');

          try {
              await db.collection("users").doc(targetUserId).update({ role: targetUserRole });
              
              setTimeout(() => {
                  bootstrap.Modal.getInstance(document.getElementById('changeRoleModal')).hide();
                  // Table updates automatically via snapshot listener
              }, 1500);
          } catch (error) {
              console.error("Error updating role:", error);
              alert("Failed to update role: " + error.message);
              // Close modal and refresh to fix dropdown visual state
              bootstrap.Modal.getInstance(document.getElementById('changeRoleModal')).hide();
              applyFilter(currentFilter);
          }
      });

      // 7. Trigger Delete User Modal
      function triggerDeleteUser(userId, userName) {
          targetUserId = userId;
          targetUserName = userName;

          document.getElementById('deleteUserText').innerText = `Are you sure you want to delete "${userName}"? This cannot be undone.`;
          
          // Reset Modal UI
          document.getElementById('deleteConfirmContent').classList.remove('d-none');
          document.getElementById('deleteLoadingContent').classList.add('d-none');
          
          new bootstrap.Modal(document.getElementById('deleteUserModal')).show();
      }

      // Handle Delete Confirmation
      document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
          // Show loading
          document.getElementById('deleteConfirmContent').classList.add('d-none');
          document.getElementById('deleteLoadingContent').classList.remove('d-none');

          try {
              await db.collection("users").doc(targetUserId).delete();
              
              setTimeout(() => {
                  bootstrap.Modal.getInstance(document.getElementById('deleteUserModal')).hide();
              }, 1500);
          } catch (error) {
              console.error("Error deleting user:", error);
              alert("Failed to delete user: " + error.message);
              bootstrap.Modal.getInstance(document.getElementById('deleteUserModal')).hide();
          }
      });

      // 8. Search Input Listener
      document.getElementById('searchUser').addEventListener('input', () => {
          applyFilter(currentFilter);
      });

    </script>
  </body>
</html>
